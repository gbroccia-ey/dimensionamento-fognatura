import { Component, OnInit, AfterViewInit } from '@angular/core';
import { BasePreventivatoreComponent } from '../../base-preventivatore/base-preventivatore';
import { NavController } from 'ionic-angular';
import { AlertController } from 'ionic-angular';
import { AdsService } from '../../../../services/ads-service';
import { Preventivo } from '../../../../models/preventivo';
import { Params } from '../../../../config/params';
import { Slides } from 'ionic-angular';
import { ViewChild } from '@angular/core';
/**
 * Generated class for the Lavfat1100AcquaComponent component.
 *
 * See https://angular.io/docs/ts/latest/api/core/index/ComponentMetadata-class.html
 * for more info on Angular Components.
 */
@Component({
  selector: 'lavfat1100-acqua',
  templateUrl: 'lavfat1100-acqua.html'
})
export class Lavfat1100AcquaComponent extends BasePreventivatoreComponent implements OnInit, AfterViewInit {

  valori: Object[] = [];
  preventivo: Preventivo;
  
  @ViewChild(Slides) slides: Slides;

  constructor(public navCtrl: NavController, 
              public alertCtrl: AlertController, public adsService: AdsService) {
                
                super(alertCtrl, adsService, navCtrl);
                
  }

  ngOnInit() {
    this.valori = Params.Valori.get("LAVFAT1100_ACQUA");
    if(this.ads.Preventivo) {
      this.preventivo = this.ads.Preventivo;
      }
    else {
        this.preventivo = new Preventivo();
        this.preventivo.Cer = 0;
        this.preventivo.Cvv = 0;
        this.preventivo.AltreSpese = 0;
        this.preventivo.Totale = 0;
        
    }

    this.slides.lockSwipes(true);
  }


  aggiornaTotale() {
    if(this.preventivo.Istruttoria) {
      this.preventivo.Totale = this.preventivo.QuotaIstruttoria;
    }
    else {
      this.preventivo.Totale = this.preventivo.QuotaFissa + this.preventivo.QuotaContatore;
    }

    this.preventivo.Totale +=  Number(this.preventivo.Cer) +  Number(this.preventivo.Cvv) +  Number(this.preventivo.AltreSpese);
   // if(this.preventivo.Cop) this.preventivo.Totale += Number(this.preventivo.Cop);
 }


  goToSlide(n) {
    this.slides.lockSwipes(false);
    this.slides.slideTo(n);
    this.slides.lockSwipes(true);

    if(n === 3) {
      if(!this.preventivo.Completato) {
        
        if(this.preventivo.Istruttoria) {
          this.preventivo.Istruttoria = true;
          this.preventivo.Rifacimento = false;
          this.preventivo.QuotaFissa = 0;
          this.preventivo.QuotaIstruttoria = 25;
          this.preventivo.QuotaContatore = 0;
          this.preventivo.Totale = Number(this.preventivo.QuotaIstruttoria);
        }
        else {
          if(this.preventivo.Rifacimento === undefined){
            this.preventivo.Rifacimento = false;
          }
          this.preventivo.Istruttoria = false;
          var row = this.valori.find(x => x["classeContatore"] === this.preventivo.ClasseContatore);
          this.preventivo.QuotaFissa = this.preventivo.Rifacimento ? row["quotaFissa"] : 0;
          this.preventivo.QuotaContatore = row["quotaVariabile"];
          this.preventivo.QuotaIstruttoria = 0;
          //this.preventivo.QuotaIstruttoria = row["quotaIstruttoria"];
          this.preventivo.Totale = Number(this.preventivo.QuotaFissa) + Number(this.preventivo.QuotaContatore);
        }   
      }
      this.aggiornaTotale();
      
    }
    
  }

  setIstruttoria() {
    if(this.preventivo.Istruttoria){
      this.preventivo.QuotaIstruttoria = 25;
    }
  }

  ngAfterViewInit() {
    if(this.preventivo.Completato) {
        setTimeout(() => {
            this.goToSlide(3);

        }, 500);
        
      }
  }

  updateCer(result) {
    this.preventivo.Cer = result;
    this.aggiornaTotale();
  }
  
  updateCvv(result) {
    this.preventivo.Cvv = result;
    this.aggiornaTotale();
  }

  /*updateCop(res: any) {
    let result = res.result;
    if(typeof result === "string"){
      result.replace(",",".");
    }
    this.preventivo.Cop = +result;
    this.adsService.updateAds(this.ads, {CopInfo: res.copinfo}, () => {}, () => {});
    this.aggiornaTotale();
  }*/
  

}
